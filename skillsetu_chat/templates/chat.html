<!DOCTYPE html>
<html>
	<head>
		<title>SkillSetu Private Chat</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 0;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
				background-color: #f0f2f5;
			}
			.chat-container {
				width: 400px;
				height: 600px;
				border: 1px solid #ddd;
				border-radius: 8px;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				background-color: white;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			.chat-header {
				background-color: #075e54;
				color: white;
				padding: 10px;
				text-align: center;
			}
			.chat-header h1 {
				margin: 0;
				font-size: 20px;
			}
			.chat-messages {
				flex-grow: 1;
				overflow-y: auto;
				padding: 10px;
			}
			#messages {
				list-style-type: none;
				padding: 0;
			}
			#messages div {
				margin-bottom: 10px;
				padding: 8px 12px;
				background-color: #e1ffc7;
				border-radius: 8px;
				max-width: 70%;
				word-wrap: break-word;
			}
			#messages div.received {
				background-color: #f0f0f0;
				align-self: flex-start;
			}
			.chat-input {
				display: flex;
				padding: 10px;
				border-top: 1px solid #ddd;
			}
			input[type="text"] {
				flex-grow: 1;
				border: none;
				padding: 10px;
				border-radius: 20px;
				margin-right: 10px;
			}
			button {
				background-color: #075e54;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 20px;
				cursor: pointer;
			}
			#login {
				text-align: center;
			}
			.chat-input {
				display: flex;
				padding: 10px;
				border-top: 1px solid #ddd;
			}
			input[type="text"],
			input[type="file"] {
				flex-grow: 1;
				border: none;
				padding: 10px;
				border-radius: 20px;
				margin-right: 10px;
			}
			button {
				background-color: #075e54;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 20px;
				cursor: pointer;
				margin-right: 5px;
			}
			#attachButton {
				background-color: #4d7c0f;
			}
		</style>
	</head>
	<body>
		<div class="chat-container">
			<div id="login">
				<h2>Login</h2>
				<input type="text" id="userId" placeholder="Enter your user ID" />
				<button onclick="login()">Login</button>
			</div>
			<div id="chat" style="display: none">
				<div class="chat-header">
					<h1>SkillSetu Private Chat</h1>
					<p>Your ID: <span id="currentUserId"></span></p>
					<input type="text" id="receiverId" placeholder="Receiver's user ID" />
				</div>
				<div class="chat-messages">
					<div id="messages"></div>
				</div>
				<div class="chat-input">
					<input type="text" id="messageInput" placeholder="Type a message..." />
					<button onclick="sendMessage()">Send</button>
					<button id="attachButton" onclick="attachDocument()">Attach</button>
					<input type="file" id="fileInput" style="display: none" onchange="handleFileSelect(event)" />
				</div>
			</div>
		</div>

		<script>
			let ws;
			let currentUserId;
			let token;

			async function login() {
				currentUserId = document.getElementById("userId").value;
				const response = await fetch(`/get_token/${currentUserId}`);
				const data = await response.json();
				token = data.access_token;

				document.getElementById("login").style.display = "none";
				document.getElementById("chat").style.display = "flex";
				document.getElementById("chat").style.flexDirection = "column";
				document.getElementById("currentUserId").textContent = currentUserId;

				connectWebSocket();
			}

			function connectWebSocket() {
				ws = new WebSocket(
					`${window.location.protocol === "https:" ? "wss:" : "ws:"}//${window.location.host}/ws/${token}`
				);

				ws.onmessage = function (event) {
					const messageData = JSON.parse(event.data);
					displayMessage(messageData);
				};

				ws.onclose = function (event) {
					console.log("WebSocket connection closed:", event);
					// Attempt to reconnect after a delay
					setTimeout(connectWebSocket, 5000);
				};
			}

			function displayMessage(messageData) {
				const messages = document.getElementById("messages");
				const message = document.createElement("div");
				message.id = messageData.id;
				message.textContent = `${messageData.sender === currentUserId ? "You" : messageData.sender}: ${
					messageData.message
				}`;
				message.className = messageData.sender === currentUserId ? "" : "received";
				messages.appendChild(message);
				messages.scrollTop = messages.scrollHeight;
			}

			async function sendMessage() {
				const receiverId = document.getElementById("receiverId").value;
				const message = document.getElementById("messageInput").value;

				if (!receiverId || !message) return;

				ws.send(
					JSON.stringify({
						receiver: receiverId,
						message: message
					})
				);

				document.getElementById("messageInput").value = "";
			}

			async function fetchChatHistory(otherUserId) {
				const response = await fetch(`/chat_history/${otherUserId}`, {
					headers: {
						Authorization: `Bearer ${token}`
					}
				});
				const history = await response.json();

				const messages = document.getElementById("messages");
				messages.innerHTML = "";
				history.forEach((msg) => {
					displayMessage({
						id: msg._id,
						sender: msg.sender,
						receiver: msg.receiver,
						message: msg.message,
						timestamp: msg.timestamp
					});
				});
			}

			function attachDocument() {
				document.getElementById("fileInput").click();
			}

			function handleFileSelect(event) {
				const file = event.target.files[0];
				if (file) {
					// This function is intentionally left half-finished
					console.log("File selected:", file.name);
					// TODO: Implement file reading and sending logic
					// For now, we'll just log the file details
					console.log("File type:", file.type);
					console.log("File size:", file.size, "bytes");

					// You would typically read the file here, e.g.:
					// const reader = new FileReader();
					// reader.onload = function(e) {
					//     const fileContent = e.target.result;
					//     // Process the file content
					// };
					// reader.readAsArrayBuffer(file);  // or readAsText for text files

					// Clear the file input for future selections
					event.target.value = "";
				}
			}

			// Event listener for Enter key in message input
			document.getElementById("messageInput").addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					sendMessage();
				}
			});

			// Event listener for Enter key in receiver input
			document.getElementById("receiverId").addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					fetchChatHistory(this.value);
				}
			});
		</script>
	</body>
</html>
