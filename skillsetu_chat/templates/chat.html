<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat App</title>
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
		<style>
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: "Roboto", sans-serif;
				background-color: #f0f2f5;
				height: 100vh;
				display: flex;
			}
			#sidebar {
				width: 350px;
				background-color: #ffffff;
				border-right: 1px solid #e0e0e0;
				display: flex;
				flex-direction: column;
			}
			#sidebar-header {
				padding: 20px;
				background-color: #00a884;
				color: white;
			}
			#chat-rooms {
				flex-grow: 1;
				overflow-y: auto;
			}
			#main-content {
				flex-grow: 1;
				display: flex;
				flex-direction: column;
				background-color: #efeae2;
				background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
			}
			#chat-header {
				padding: 15px 20px;
				background-color: #f0f0f0;
				border-bottom: 1px solid #e0e0e0;
			}
			#chat-container {
				flex-grow: 1;
				padding: 20px;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
			}
			#input-container {
				padding: 15px;
				background-color: #f0f0f0;
				display: flex;
				align-items: center;
			}
			#messageInput {
				flex-grow: 1;
				padding: 10px 15px;
				border: none;
				border-radius: 20px;
				font-size: 14px;
			}
			#sendButton {
				background-color: #00a884;
				color: white;
				border: none;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				margin-left: 10px;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.chat-room {
				cursor: pointer;
				padding: 15px 20px;
				border-bottom: 1px solid #f0f0f0;
				transition: background-color 0.2s;
			}
			.chat-room:hover {
				background-color: #f5f5f5;
			}
			.chat-room.active {
				background-color: #ebebeb;
			}
			.message {
				max-width: 65%;
				margin-bottom: 10px;
				padding: 10px 15px;
				border-radius: 7.5px;
				font-size: 14px;
				line-height: 1.4;
				word-wrap: break-word;
			}
			.sent {
				align-self: flex-end;
				background-color: #dcf8c6;
				border-top-right-radius: 0;
			}
			.received {
				align-self: flex-start;
				background-color: #ffffff;
				border-top-left-radius: 0;
			}
			.message-time {
				font-size: 11px;
				color: #999;
				margin-top: 5px;
				text-align: right;
			}
		</style>
	</head>
	<body>
		<div id="sidebar">
			<div id="sidebar-header">
				<h2>Chat Rooms</h2>
			</div>
			<div id="chat-rooms">
				<div class="chat-room" data-chat-id="chat1">Chat 1</div>
				<div class="chat-room" data-chat-id="chat2">Chat 2</div>
				<div class="chat-room" data-chat-id="chat3">Chat 3</div>
			</div>
		</div>
		<div id="main-content">
			<div id="chat-header">
				<h3 id="current-chat-name">Chat 1</h3>
			</div>
			<div id="chat-container"></div>
			<div id="input-container">
				<input type="text" id="messageInput" placeholder="Type a message..." />
				<button id="sendButton">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="24"
						height="24"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round">
						<line x1="22" y1="2" x2="11" y2="13"></line>
						<polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
					</svg>
				</button>
			</div>
		</div>

		<script>
			let ws;
			let currentChatId;
			const clientId = Date.now();
			const chatContainer = document.getElementById("chat-container");
			const messageInput = document.getElementById("messageInput");
			const sendButton = document.getElementById("sendButton");
			const chatRooms = document.querySelectorAll(".chat-room");
			const currentChatName = document.getElementById("current-chat-name");

			function connectWebSocket(chatId) {
				if (ws) {
					ws.close();
				}
				ws = new WebSocket(`wss://${window.location.host}/ws/${chatId}/${clientId}`);
				currentChatId = chatId;

				ws.onmessage = function (event) {
					const message = event.data;
					displayMessage(message);
				};

				ws.onclose = function (event) {
					console.log("WebSocket is closed now.");
				};

				ws.onerror = function (event) {
					console.error("WebSocket error observed:", event);
				};

				// Load chat history
				fetch(`/chat_history/${chatId}`)
					.then((response) => response.json())
					.then((messages) => {
						chatContainer.innerHTML = "";
						messages.forEach((msg) => {
							displayMessage(`Client #${msg.client_id} says: ${msg.message}`, new Date(msg.timestamp));
						});
					});
			}

			function displayMessage(message, timestamp = new Date()) {
				const messageElement = document.createElement("div");
				messageElement.classList.add("message");

				const textElement = document.createElement("div");
				textElement.textContent = message;
				messageElement.appendChild(textElement);

				const timeElement = document.createElement("div");
				timeElement.classList.add("message-time");
				timeElement.textContent = formatTime(timestamp);
				messageElement.appendChild(timeElement);

				if (message.startsWith("You wrote:")) {
					messageElement.classList.add("sent");
				} else {
					messageElement.classList.add("received");
				}
				chatContainer.appendChild(messageElement);
				chatContainer.scrollTop = chatContainer.scrollHeight;
			}

			function formatTime(date) {
				return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
			}

			sendButton.onclick = function () {
				if (messageInput.value) {
					ws.send(messageInput.value);
					messageInput.value = "";
				}
			};

			messageInput.onkeyup = function (event) {
				if (event.key === "Enter") {
					sendButton.click();
				}
			};

			chatRooms.forEach((room) => {
				room.addEventListener("click", function () {
					chatRooms.forEach((r) => r.classList.remove("active"));
					this.classList.add("active");
					connectWebSocket(this.dataset.chatId);
					currentChatName.textContent = this.textContent;
				});
			});

			// Connect to the first chat room by default
			connectWebSocket("chat1");
			chatRooms[0].classList.add("active");
		</script>
	</body>
</html>
