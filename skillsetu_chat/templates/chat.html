<!DOCTYPE html>
<html>
	<head>
		<title>SkillSetu Private Chat</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 0;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
				background-color: #f0f2f5;
			}
			.chat-container {
				width: 800px;
				height: 600px;
				border: 1px solid #ddd;
				border-radius: 8px;
				overflow: scroll;
				display: flex;
				flex-direction: column;
				background-color: white;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			.chat-header {
				background-color: #075e54;
				color: white;
				padding: 10px;
				text-align: center;
			}
			.chat-header h1 {
				margin: 0;
				font-size: 20px;
			}
			.chat-messages {
				flex-grow: 1;
				overflow-y: auto;
				padding: 10px;
				display: flex;
				flex-direction: column;
			}
			#messages {
				list-style-type: none;
				padding: 0;
				margin: 0;
				overflow-y: auto;
				flex-grow: 1;
			}
			#messages div {
				margin-bottom: 10px;
				padding: 8px 12px;
				background-color: #e1ffc7;
				border-radius: 8px;
				max-width: 70%;
				word-wrap: break-word;
			}
			#messages div.received {
				background-color: #f0f0f0;
				align-self: flex-start;
			}
			.chat-input {
				display: flex;
				padding: 10px;
				border-top: 1px solid #ddd;
			}
			input[type="text"] {
				flex-grow: 1;
				border: none;
				padding: 10px;
				border-radius: 20px;
				margin-right: 10px;
			}
			button {
				background-color: #075e54;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 20px;
				cursor: pointer;
			}
			#login {
				text-align: center;
			}
			.chat-input {
				display: flex;
				padding: 10px;
				border-top: 1px solid #ddd;
			}
			input[type="text"],
			input[type="file"] {
				flex-grow: 1;
				border: none;
				padding: 10px;
				border-radius: 20px;
				margin-right: 10px;
			}
			button {
				background-color: #075e54;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 20px;
				cursor: pointer;
				margin-right: 5px;
			}
			#attachButton {
				background-color: #4d7c0f;
			}
			#file-name {
				padding: 10px;
				max-height: 60px;
				overflow-y: auto;
			}

			a {
				color: #075e54;
				text-decoration: none;
			}

			a:hover {
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<div class="chat-container">
			<div id="login">
				<h2>Login</h2>
				<input type="text" id="userId" placeholder="Enter your user ID" />
				<button onclick="login()">Login</button>
			</div>
			<div id="chat" style="display: none">
				<div class="chat-header">
					<h1>SkillSetu Private Chat</h1>
					<p>Your ID: <span id="currentUserId"></span></p>
					<input type="text" id="receiverId" placeholder="Receiver's user ID" />
				</div>
				<div class="chat-messages">
					<div id="messages"></div>
				</div>
				<div id="file-name"></div>
				<div class="chat-input">
					<input type="text" id="messageInput" placeholder="Type a message..." />
					<button onclick="sendMessage()">Send</button>
					<button id="attachButton" onclick="attachDocument()">Attach</button>
					<input
						type="file"
						id="fileInput"
						style="display: none"
						onchange="handleFileSelect(event)"
						multiple />
				</div>
			</div>
		</div>

		<script>
			let ws;
			let currentUserId;
			let token;
			let filesToSend = [];

			async function login() {
				currentUserId = document.getElementById("userId").value;
				const response = await fetch(`/get_token/${currentUserId}`);
				const data = await response.json();
				token = data.access_token;

				document.getElementById("login").style.display = "none";
				document.getElementById("chat").style.display = "flex";
				document.getElementById("chat").style.flexDirection = "column";
				document.getElementById("currentUserId").textContent = currentUserId;

				connectWebSocket();
			}

			function connectWebSocket() {
				ws = new WebSocket(
					`${window.location.protocol === "https:" ? "wss:" : "ws:"}//${window.location.host}/ws/${token}`
				);

				ws.onmessage = function (event) {
					const messageData = JSON.parse(event.data);
					displayMessage(messageData);
				};

				ws.onclose = function (event) {
					console.log("WebSocket connection closed:", event);
					// Attempt to reconnect after a delay
					setTimeout(connectWebSocket, 5000);
				};
			}

			function displayMessage(messageData) {
				const messages = document.getElementById("messages");
				const message = document.createElement("div");

				message.id = messageData.id;
				message.textContent = `${messageData.sender === currentUserId ? "You" : messageData.sender}: ${
					messageData.message
				}`;

				if (messageData.attachments) {
					const attachments = document.createElement("div");
					attachments.textContent = "Attachments:";
					message.appendChild(attachments);

					messageData.attachments.forEach((attachment) => {
						let extension = attachment.split(".")[attachment.split(".").length - 1];
						console.log(attachment, extension);

						if (extension === "jpg" || extension === "jpeg" || extension === "png" || extension === "gif") {
							const img = document.createElement("img");
							img.src = attachment;
							img.style.maxWidth = "100%";
							img.style.maxHeight = "100%";
							img.alt = attachment.split("/").pop();
							attachments.appendChild(img);
						} else {
							const link = document.createElement("a");
							link.href = attachment;
							link.textContent = attachment.split("/").pop();
							link.target = "_blank";
							attachments.appendChild(link);
						}
					});
				}

				message.className = messageData.sender === currentUserId ? "" : "received";
				messages.appendChild(message);
				messages.scrollTop = messages.scrollHeight;
			}

			async function sendMessage() {
				const receiverId = document.getElementById("receiverId").value;
				const message = document.getElementById("messageInput").value;

				if (!receiverId || !message) return;

				if (filesToSend.length > 0) {
					ws.send(
						JSON.stringify({
							receiver: receiverId,
							message: message,
							attachments: filesToSend.map((file) => file.url)
						})
					);

					filesToSend = [];
					document.getElementById("file-name").textContent = "";
				} else {
					ws.send(
						JSON.stringify({
							receiver: receiverId,
							message: message
						})
					);
				}

				document.getElementById("messageInput").value = "";
			}

			async function fetchChatHistory(otherUserId) {
				const response = await fetch(`/chat_history/${otherUserId}`, {
					headers: {
						Authorization: `Bearer ${token}`
					}
				});
				const history = await response.json();

				const messages = document.getElementById("messages");
				messages.innerHTML = "";
				history.forEach((msg) => {
					displayMessage({
						id: msg._id,
						sender: msg.sender,
						receiver: msg.receiver,
						message: msg.message,
						timestamp: msg.timestamp,
						attachments: msg.attachments
					});
				});
			}

			function attachDocument() {
				document.getElementById("fileInput").click();
			}

			async function handleFileSelect(event) {
				const files = event.target.files;
				if (files.length > 0) {
					console.log(`${files.length} file(s) selected`);

					const uploadedFileInfo = await uploadFiles(files);
					console.log("Uploaded files:", uploadedFileInfo);
					if (uploadedFileInfo) {
						const fileNames = uploadedFileInfo.map((file) => file.original_file_name).join(", ");
						filesToSend = uploadedFileInfo;
						document.getElementById("file-name").textContent = `Selected files: ${fileNames}`;
					} else {
						alert("File upload failed. Please try again.");
					}

					// Clear the file input for future selections
					event.target.value = "";
				}
			}

			async function uploadFiles(files) {
				const receiverId = document.getElementById("receiverId").value;
				const formData = new FormData();

				formData.append("other_user_id", receiverId);
				for (let file of files) {
					formData.append("files", file);
				}

				try {
					const response = await fetch("/upload_files", {
						method: "POST",
						body: formData,
						headers: {
							Authorization: `Bearer ${token}`
						}
					});

					if (!response.ok) {
						throw new Error("File upload failed");
					}

					const result = await response.json();
					return result.files;
				} catch (error) {
					console.error("Error uploading files:", error);
					return null;
				}
			}

			// Event listener for Enter key in message input
			document.getElementById("messageInput").addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					sendMessage();
				}
			});

			// Event listener for Enter key in receiver input
			document.getElementById("receiverId").addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					fetchChatHistory(this.value);
				}
			});
		</script>
	</body>
</html>
